<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Minimalista - Monitoreo Ambiental</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Monitoreo</h1>
            <p>Dashboard Minimalista - Monitoreo Ambiental</p>
        </div>
        <!-- Barra de estado (importante para mostrar conexión) -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="connectionStatus"></div>
                <span class="status-text">Estado de Conexión</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="sensorStatus"></div>
                <span class="status-text">Estado del Sensor</span>
            </div>
            <div class="status-item">
                <span class="status-text">Cliente ID: <span id="clientId">--</span></span>
            </div>
            <div class="status-item">
                <span class="status-text">Última Actualización: <span id="lastUpdate">--</span></span>
            </div>
        </div>

        <div class="main-content">
            <!-- Tarjeta de Temperatura -->
            <div class="card">
                <h2>Temperatura</h2>
                <div class="main-value" id="currentTemperature">--</div>
                <div class="value-unit">°C</div>
            </div>
            <!-- Tarjeta de Humedad -->
            <div class="card">
                <h2>Humedad</h2>
                <div class="main-value" id="currentHumidity">--</div>
                <div class="value-unit">%</div>
            </div>
            <!-- Tarjeta de Calidad de Aire -->
            <div class="card">
                <h2>Calidad de Aire</h2>
                <div class="main-value" id="currentAirQuality">--</div>
                <div class="value-unit">Valor MQ135</div>
            </div>
            <!-- Tarjeta de Información del Sistema -->
            <div class="card">
                <h2>Información del Sistema</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Dirección IPv6:</div>
                        <div class="info-value" id="ipv6Address">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Timestamp:</div>
                        <div class="info-value" id="timestamp">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Cliente ID:</div>
                        <div class="info-value" id="clientIdDisplay">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Estado:</div>
                        <div class="info-value" id="systemStatus">Conectando...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones básicos -->
        <div class="controls">
            <button class="btn" id="startBtn">Iniciar Monitoreo</button>
            <button class="btn" id="stopBtn">Detener Monitoreo</button>
        </div>
    </div>

    <script>
        let ws = null;
        let isMonitoring = false;
        let clientId = Math.random().toString(36).substr(2, 9);

        function connectWebSocket() {
            const wsUrl = `ws://localhost:8000/ws`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                updateConnectionStatus(true);
                document.getElementById('sensorStatus').classList.add('connected');
            };
            ws.onclose = function() {
                updateConnectionStatus(false);
                document.getElementById('sensorStatus').classList.remove('connected');
                setTimeout(connectWebSocket, 3000); // Reconexión automática
            };
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateUI(data);
                } catch (error) {}
            };
        }

        function updateUI(data) {
            document.getElementById('currentTemperature').textContent = data.temperature !== null ? data.temperature.toFixed(1) : '--';
            document.getElementById('currentHumidity').textContent = data.humidity !== null ? data.humidity.toFixed(1) : '--';
            document.getElementById('currentAirQuality').textContent = data.air_quality !== null ? data.air_quality : '--';
            document.getElementById('ipv6Address').textContent = data.ipv6_address || '--';
            document.getElementById('timestamp').textContent = data.timestamp ? new Date(data.timestamp).toLocaleString('es-ES') : '--';
            document.getElementById('clientIdDisplay').textContent = clientId;
            document.getElementById('clientId').textContent = clientId;
            document.getElementById('systemStatus').textContent = 'Conectado';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connectionStatus');
            const systemStatus = document.getElementById('systemStatus');
            if (connected) {
                statusIndicator.classList.add('connected');
                systemStatus.textContent = 'Conectado';
                systemStatus.style.color = '#10b981';
            } else {
                statusIndicator.classList.remove('connected');
                systemStatus.textContent = 'Desconectado';
                systemStatus.style.color = '#ef4444';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('startBtn').onclick = function() {
                if (!isMonitoring) {
                    isMonitoring = true;
                    connectWebSocket();
                    this.classList.add('active');
                }
            };
            document.getElementById('stopBtn').onclick = function() {
                if (isMonitoring) {
                    isMonitoring = false;
                    if (ws) ws.close();
                    document.getElementById('startBtn').classList.remove('active');
                }
            };
            updateConnectionStatus(false);
            document.getElementById('sensorStatus').classList.remove('connected');
        });
    </script>
</body>
</html>
